<%
  content_for :title, "매물 검색 | 네이버 부동산"
%>

<div class="min-h-screen bg-gray-50">
  <!-- Main container with sidebar and content -->
  <div class="flex">
    
    <!-- Desktop Filter Sidebar -->
    <div class="hidden lg:block w-80 bg-white shadow-sm border-r border-gray-200 h-screen sticky top-0 overflow-y-auto">
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-semibold text-gray-900">상세 조건</h2>
          
          <% if @has_filters %>
            <%= link_to properties_path, 
                class: "text-sm text-red-600 hover:text-red-800 font-medium" do %>
              전체 초기화
            <% end %>
          <% end %>
        </div>
        
        <!-- Filter Form -->
        <%= form_with url: properties_path, method: :get, local: true, class: "space-y-6", data: { controller: "property-filters", action: "submit->property-filters#submit" } do |form| %>
          
          <!-- Location Selection -->
          <div class="filter-section">
            <%= render 'components/location_hierarchy',
                label: '지역',
                name: 'locations',
                selected: params[:locations] || [],
                multiple: true,
                search: true %>
          </div>
          
          <!-- Transaction Type -->
          <div class="filter-section">
            <%= render 'components/select_field',
                label: '거래유형',
                name: 'transaction_type',
                value: params[:transaction_type],
                placeholder: '전체',
                options: @filter_options[:transaction_types] %>
          </div>
          
          <!-- Property Types -->
          <div class="filter-section">
            <%= render 'components/multi_checkbox',
                label: '매물유형',
                name: 'property_types',
                options: @filter_options[:property_types],
                selected: params[:property_types] || [],
                columns: 2,
                select_all: true %>
          </div>
          
          <!-- Price Range -->
          <div class="filter-section">
            <div class="mb-4">
              <h3 class="text-sm font-medium text-gray-700 mb-3">가격 조건</h3>
              
              <!-- Sale Price -->
              <div class="mb-4" data-show-if="transaction_type" data-show-values="sale,">
                <%= render 'components/range_slider',
                    label: '매매가',
                    name: 'sale_price',
                    min: 0,
                    max: 3000000000,
                    step: 10000000,
                    value_min: params.dig(:sale_price, :min)&.to_i || 0,
                    value_max: params.dig(:sale_price, :max)&.to_i || 1000000000,
                    format: 'currency',
                    show_inputs: true %>
              </div>
              
              <!-- Jeonse Deposit -->
              <div class="mb-4" data-show-if="transaction_type" data-show-values="jeonse,">
                <%= render 'components/range_slider',
                    label: '보증금 (전세)',
                    name: 'jeonse_deposit',
                    min: 0,
                    max: 2000000000,
                    step: 10000000,
                    value_min: params.dig(:jeonse_deposit, :min)&.to_i || 0,
                    value_max: params.dig(:jeonse_deposit, :max)&.to_i || 500000000,
                    format: 'currency',
                    show_inputs: true %>
              </div>
              
              <!-- Monthly Rent -->
              <div class="mb-4" data-show-if="transaction_type" data-show-values="monthly,">
                <%= render 'components/range_slider',
                    label: '월세',
                    name: 'monthly_rent',
                    min: 0,
                    max: 5000000,
                    step: 50000,
                    value_min: params.dig(:monthly_rent, :min)&.to_i || 0,
                    value_max: params.dig(:monthly_rent, :max)&.to_i || 2000000,
                    format: 'currency',
                    show_inputs: true %>
              </div>
            </div>
          </div>
          
          <!-- Area Conditions -->
          <div class="filter-section">
            <div class="mb-4">
              <h3 class="text-sm font-medium text-gray-700 mb-3">면적 조건</h3>
              
              <!-- Unit Toggle -->
              <%= render 'components/unit_toggle',
                  current_unit: params[:area_unit] || 'pyeong',
                  name: 'area_unit' %>
              
              <!-- Exclusive Area -->
              <div class="mb-4">
                <%= render 'components/range_slider',
                    label: '전용면적',
                    name: 'exclusive_area',
                    min: 0,
                    max: 500,
                    step: 1,
                    value_min: params.dig(:exclusive_area, :min)&.to_i || 0,
                    value_max: params.dig(:exclusive_area, :max)&.to_i || 200,
                    format: 'area',
                    show_inputs: true %>
              </div>
              
              <!-- Supply Area -->
              <div class="mb-4">
                <%= render 'components/range_slider',
                    label: '공급면적',
                    name: 'supply_area',
                    min: 0,
                    max: 600,
                    step: 1,
                    value_min: params.dig(:supply_area, :min)&.to_i || 0,
                    value_max: params.dig(:supply_area, :max)&.to_i || 250,
                    format: 'area',
                    show_inputs: true %>
              </div>
            </div>
          </div>
          
          <!-- Room & Building Info -->
          <div class="filter-section">
            <div class="space-y-4">
              <!-- Room Count -->
              <%= render 'components/select_field',
                  label: '방 개수',
                  name: 'room_count',
                  value: params[:room_count],
                  placeholder: '전체',
                  options: @filter_options[:room_counts] %>
              
              <!-- Bathroom Count -->
              <%= render 'components/select_field',
                  label: '욕실 개수', 
                  name: 'bathroom_count',
                  value: params[:bathroom_count],
                  placeholder: '전체',
                  options: @filter_options[:bathroom_counts] %>
              
              <!-- Built Year -->
              <%= render 'components/range_slider',
                  label: '사용승인년도',
                  name: 'built_year',
                  min: 1990,
                  max: 2024,
                  step: 1,
                  value_min: params.dig(:built_year, :min)&.to_i || 2000,
                  value_max: params.dig(:built_year, :max)&.to_i || 2024,
                  format: 'year',
                  show_inputs: false %>
            </div>
          </div>
          
          <!-- Direction & Features -->
          <div class="filter-section">
            <div class="space-y-4">
              <!-- Direction -->
              <%= render 'components/direction_picker',
                  label: '방향',
                  name: 'direction',
                  selected: params[:direction] || [],
                  style: 'list',
                  multiple: true %>
              
              <!-- Floor -->
              <%= render 'components/floor_selector',
                  label: '층수',
                  name: 'floor',
                  value: params[:floor],
                  placeholder: '예: 5/15, 10-12/20' %>
              
              <!-- Features -->
              <div class="space-y-3">
                <%= render 'components/toggle',
                    label: '엘리베이터',
                    name: 'has_elevator',
                    checked: params[:has_elevator].present? %>
                
                <%= render 'components/toggle',
                    label: '사진 있는 매물만',
                    name: 'has_photos',
                    checked: params[:has_photos].present?,
                    color: 'green' %>
              </div>
              
              <!-- Parking Ratio -->
              <%= render 'components/range_slider',
                  label: '주차 비율',
                  name: 'parking_ratio',
                  min: 0.0,
                  max: 2.0,
                  step: 0.1,
                  value_min: params.dig(:parking_ratio, :min)&.to_f || 0.0,
                  value_max: params.dig(:parking_ratio, :max)&.to_f || 2.0,
                  format: 'ratio',
                  show_inputs: false %>
            </div>
          </div>
          
          <!-- Submit Buttons -->
          <div class="pt-4 space-y-3">
            <%= form.submit "조건으로 검색", 
                class: "w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors" %>
          </div>
        <% end %>
      </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="flex-1">
      
      <!-- Mobile Filter Button (shown on mobile only) -->
      <div class="lg:hidden bg-white border-b border-gray-200 px-4 py-3">
        <button type="button" 
                class="flex items-center justify-center w-full py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                data-action="click->mobile-filter#open">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
          </svg>
          필터 (<%= @has_filters ? "적용됨" : "전체" %>)
        </button>
      </div>
      
      <!-- Results Header -->
      <div class="bg-white border-b border-gray-200 px-4 lg:px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <h1 class="text-xl font-semibold text-gray-900">
              매물 검색 결과
            </h1>
            
            <div class="text-sm text-gray-600">
              총 <span class="font-semibold text-blue-600"><%= number_with_delimiter(@total_count) %></span>개
            </div>
          </div>
          
          <!-- Sort Options -->
          <div class="flex items-center space-x-3">
            <label class="text-sm text-gray-600">정렬:</label>
            <%= select_tag :sort, 
                options_for_select([
                  ['최신순', 'latest'],
                  ['가격낮은순', 'price_low'],
                  ['가격높은순', 'price_high'],
                  ['면적넓은순', 'area_large'],
                  ['면적좁은순', 'area_small']
                ], params[:sort]),
                class: "text-sm border border-gray-300 rounded-lg px-3 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
          </div>
        </div>
        
        <!-- Applied Filters -->
        <% if @has_filters %>
          <div class="mt-4">
            <div class="flex items-center flex-wrap gap-2">
              <span class="text-sm text-gray-600 mr-2">적용된 필터:</span>
              
              <!-- Show applied filters as removable tags -->
              <% if params[:transaction_type].present? %>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  거래유형: <%= @filter_options[:transaction_types].find { |t| t[:value] == params[:transaction_type] }&.dig(:label) %>
                  <%= link_to properties_path(params.except(:transaction_type)), class: "ml-1 text-blue-600 hover:text-blue-800" do %>
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                  <% end %>
                </span>
              <% end %>
              
              <%= link_to properties_path, 
                  class: "text-xs text-red-600 hover:text-red-800 font-medium ml-2" do %>
                전체 해제
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
      
      <!-- Property Results -->
      <div class="p-4 lg:p-6">
        <% if @properties.any? %>
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <% @properties.each do |property| %>
              <%= render 'property_card', property: property %>
            <% end %>
          </div>
          
          <!-- Pagination -->
          <div class="mt-8 flex justify-center">
            <nav class="flex items-center space-x-2">
              <button class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">이전</button>
              <button class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-lg">1</button>
              <button class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">2</button>
              <button class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">3</button>
              <button class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">다음</button>
            </nav>
          </div>
          
        <% else %>
          <!-- Empty State -->
          <div class="text-center py-12">
            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
            </svg>
            
            <h3 class="text-lg font-medium text-gray-900 mb-2">검색 결과가 없습니다</h3>
            <p class="text-gray-600 mb-4">다른 조건으로 검색해보시거나 필터를 조정해보세요.</p>
            
            <%= link_to properties_path, 
                class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700" do %>
              전체 매물 보기
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Filter Modal (will be implemented later) -->
<div id="mobile-filter-modal" class="lg:hidden" data-controller="mobile-filter">
  <!-- Mobile filter modal content -->
</div>